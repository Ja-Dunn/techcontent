<properties
	pageTitle="Azure Insights：Azure Insights 自动缩放的最佳做法。| Azure"
	description="了解原理，以有效地在 Azure Insights 中使用自动缩放。"
	authors="kamathashwin"
	manager=""
	editor=""
	services="azure-portal"
	documentationCenter="na"/>

<tags
	ms.service="azure-portal"
	ms.date="07/15/2016"
	wacn.date="08/08/2016"/>

# Azure Insights 自动缩放的最佳做法

本文档中的以下部分将帮助你了解有关 Azure Insights 中的自动缩放的最佳做法。查看此信息之后，你将能够更好地在 Azure 基础结构中有效地使用自动缩放。

## 自动缩放概念

- 一个资源只能具有一个自动缩放设置
- 自动缩放设置可以具有一个或多个配置文件，每个配置文件可以具有一个或多个自动缩放规则。
- 自动缩放设置可水平缩放实例，它在增加实例时是扩大，在减少实例数时是缩小。自动缩放设置具有最大、最小和默认实例值。
- 自动缩放作业始终读取要作为缩放依据的关联指标，检查它是否超过针对扩大或缩小配置的阈值。可以在 [Azure Insights 自动缩放常用指标](/documentation/articles/insights-autoscale-common-metrics/)是查看可以作为自动缩放依据的指标的列表。
- 所有阈值都在实例级别进行计算。例如，“如果实例计数为 2，则在平均 CPU > 80% 时按 1 个实例进行扩大”表示在所有实例间的平均 CPU 大于 80% 时进行扩大。
- 你会始终通过电子邮件收到故障通知。具体而言，目标资源的所有者、参与者和访问者会收到电子邮件。当自动缩放从故障中恢复并开始正常工作时，你也始终会收到恢复电子邮件。
- 可以选择加入以通过电子邮件和 webhook 接收成功缩放操作通知。

## 自动缩放最佳做法

使用自动缩放时，可使用以下最佳做法。

### 确保最大和最小值不同，并且它们之间具有足够的余量
如果你的设置的最大值为 2，最小值为 2 并且当前实例计数为 2，则不可能进行缩放操作。建议设置是在最大和最小实例计数之间保留足够的余量。自动缩放始终在这些限制之间（包含限制在内）进行缩放。但是，假定你决定手动将实例计数扩大（更新）到大于最大值的值。自动缩放作业下次运行时，它会检查当前实例计数是否大于最大值 — 如果是这样，则会缩小为最大值（不考虑对规则设置的阈值）。同样，如果你手动使当前实例计数小于最小值，则自动缩放作业下次运行时，它会扩大到最小实例数。

### 始终使用执行增加和减少的扩大和缩小规则组合

如果只使用该组合的一部分，则自动缩放只会进行单向扩大或缩小，直到达到最大值或最小值。

### 管理自动缩放时，请勿在 Azure 门户预览与 Azure 经典管理门户之间切换
对于云服务和应用程序服务 (Web Apps)，请使用 [Azure 门户预览](https://portal.azure.cn) 创建和管理自动缩放设置。对于虚拟机规模集，请使用 PoSH、CLI 或 REST API 创建和管理自动缩放设置。管理自动缩放配置时，请勿在 [Azure 经典管理门户](https://manage.windowsazure.cn) 与 [Azure 门户预览](https://portal.azure.cn) 之间切换。Azure 经典管理门户及其基础后端具有限制。请使用图形用户界面移动到 Azure 门户预览来管理自动缩放。这些选项是使用自动缩放 PowerShell、CLI 或 REST API（通过 Azure 资源浏览器）。

### 为诊断指标选择相应统计信息
对于诊断指标，可以选择“平均”、“最小值”、“最大值”和“总计”作为用作缩放依据的指标。最常见的统计信息是“平均值”。

### 认真为所有指标类型选择阈值
我们建议基于实际情况为扩大和缩小认真选择不同阈值。

我们建议不要使用如同以下示例的自动缩放设置，其中针对扩大和缩小条件的阈值相同或非常相似：

- 当线程计数 <= 600 时，按 1 计数增加实例
- 当线程计数 >= 600 时，按 1 计数减少实例


让我们看一下可能会导致看起来令人困惑的行为的示例。假定开始有 2 个实例，随后每个实例的平均线程数增长到 625。自动缩放会通过添加第三个实例进行扩大。接下来，假定实例间的平均线程数下降到 575。进行减少之前，自动缩放会尝试估计缩小后的最终状态。例如，575 x 3（当前实例计数）= 1,725/2（减少后的最终实例数）= 862.5 个线程。这意味着如果平均线程计数保持不变，甚至是仅仅少量下降，则自动缩放必须立即再次扩大（即使在进行缩小之后）。但是，如果它再次增加，则整个过程会重复，从而导致无限循环。为了避免这种波动情况，自动缩放根本不会减少。相反，它会跳过，并在服务作业下次执行时再次重新评估条件。这可能会使许多人感到困惑，因为在平均线程计数是 575 时，自动缩放似乎未起作用。

缩小过程中的这种估计行为旨在避免波动情况。为扩大和缩小选择相同阈值时，应记住此行为。

我们建议在扩大与缩小阈值之间选择足够的余量。作为示例，请考虑以下更好的规则组合。

- 当 CPU% >= 80 时，按 1 计数增加实例
- 当 CPU% <= 60 时，按 1 计数减少实例

我们来回顾一下此示例的工作原理。假定开始有 2 个实例。如果实例间的平均 CPU% 达到 80，则自动缩放会通过添加第三个实例来进行扩大。现在假定随着时间的推移，CPU% 下降到 60。自动缩放的缩小规则会估计缩小后的最终动态。例如，60 x 3（当前实例计数）= 180/2（减少后的最终实例数）= 90。因此自动缩放不会缩小，因为它必须立即再次扩大。相反，它会跳过减少。接下来，假定在下次检查时，CPU 继续下降到 50，随后再次估计 — 50 x 3 个实例 = 150/2 个实例 = 75，这低于扩大阈值 80，因此可以成功缩小为 2 个实例。

### 有关特殊指标的缩放阈值的注意事项
 对于特殊指标（如存储或服务总线队列长度指标），阈值是按照当前实例数可用的消息平均数。请认真为此指标选择阈值。

我们来通过一个示例演示它，以确保你更好地了解行为。

- 当存储队列消息计数 >= 50 时，按 1 计数增加实例
- 当存储队列消息计数 <= 10 时，按 1 计数减少实例

假定开始有 2 个实例。接下来，假定消息不断传入，而当你检查存储队列时，总计数达到 50。你可能认为自动缩放应启动扩大操作。但请注意，它仍是 50/2 = 25 个消息/实例。因此，不会进行扩大。要进行第一次扩大，存储队列中的总消息计数应是 100。接下来，假定总消息计数达到 100。会由于扩大操作而添加第三个实例。在队列中的总消息计数达到 300 之前，都不会进行下一次扩大操作。我们来了解一下缩小操作。假定实例数是 3。当队列中的总消息数达到 30 时，会进行第一缩小操作，使得 30/3 = 10 个消息/实例（这是缩小阈值）。

### 有关在自动缩放设置中配置多个配置文件时进行自动缩放的注意事项

在自动缩放设置中，可以选择默认配置文件（这会始终应用，对计划或时间没有任何依赖），也可以选择定期配置文件或用于具有日期和时间范围的固定期间的配置文件。

当自动缩放服务处理它们时，它会始查按以下顺序进行检查：

1. 固定的日期配置文件
2. 定期配置文件
3. 默认（“始终”）配置文件

如果满足配置文件条件，则自动缩放不会检查位于其下的下一个配置文件条件。自动缩放一次只处理一个配置文件。这意味着如果还要包括来自较低层配置文件的处理条件，则必须在当前配置文件中也包含这些规则。

我们使用示例对此进行回顾：

下图显示一个自动缩放设置，其默认配置文件的最小实例数 = 2，最大实例数 = 10。在此示例中，规则配置为在队列中的消息计数大于 10 时进行扩大，在队列中的消息计数小于 3 时进行缩小。因此，现在资源可以在 2 到 10 个实例之间进行缩放。

此外，为星期一设置了定期配置文件。它设置为最小实例数 = 2，并且最大实例数 = 12。这意味着在星期一，自动缩放首次检查此条件时，如果实例计数是 2，则会将它缩放为新的最小值 3。只要自动缩放继续发现匹配此配置文件条件（星期一），它便只处理为此配置文件配置的基于 CPU 的扩大/缩小规则。此时，它不会检查队列长度。但是，如果你还要检查队列长度条件，则应在星期一配置文件中也包括默认配置文件中的那些规则。

同样，当自动缩放切换回默认配置文件时，它会首先检查是否符合最小值和最大值条件。如果当时的实例数是 12，则它会缩小为 10（默认配置文件运行的最大值）。

![自动缩放设置](./media/insights-autoscale-best-practices/insights-autoscale-best-practices.png)

### 有关在配置文件中配置多个规则时进行自动缩放的注意事项
在某些情况下可能必须在一个配置文件中设置多个规则。设置了多个规则时，服务会使用以下自动缩放规则集。

进行扩大时，如果满足任何规则，则自动缩放会运行。
进行缩小时，自动缩放需要满足所有规则。
 
为进行说明，假定你具有以下 4 个自动缩放规则：
 
- 如果 CPU < 30 %，则按 1 进行 缩小
- ​如果内存 < 50%，则按 1 进行缩小
- ​如果 CPU > 75 %，则按 1 进行扩大
- ​如果内存 > 75%，则按 1 进行扩大

随后发生以下事件：
- 如果 CPU 是 76% 且内存是 50%，则我们会进行扩大。
- 如果 CPU 是 50% 且内存是 76%，则我们会进行扩大。
 
另一方面，如果 CPU 是 25% 且内存是 51%，则自动缩放**不会**缩小。要进行缩小，CPU 必须是 29% 且内存是 49%。

### 始终选择安全的默认实例计数
默认实例计数十分重要，因为它是在指标不可用时，自动缩放将服务缩放到的实例计数。因此，请选择对工作负荷安全的默认实例计数。

### 配置自动缩放通知
如果发生以下任何情况，则自动缩放会通过电子邮件通知资源的管理员和参与者：
 - 自动缩放服务未能执行操作。
 - 指标不可用于使自动缩放服务进行缩放决策。
 - 指标再次可用（恢复）于进行缩放决策。除了以上条件，还可以配置电子邮件或 webhook 通知，以获得有关成功缩放操作的通知。

<!---HONumber=Mooncake_0503_2016-->